{% extends 'template.html' %}

{% block import %}
<link rel="stylesheet" href="/static/bootstrap-select/dist/css/bootstrap-select.min.css">
<script src="{{ url_for('static', filename = 'bootstrap-select/dist/js/bootstrap-select.js') }}"></script>

<link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-fileinput/4.4.9/css/fileinput.min.css" media="all" rel="stylesheet" type="text/css" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-fileinput/4.4.9/js/fileinput.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-fileinput/4.4.9/js/locales/zh.js"></script>
<style>
    .content-inner {
        display: flex;
    }
    label.required:before {
        content: '* ';
        color: red;
    }
    .has-feedback label~.form-control-feedback {
        top: 32px;
    }
    .operate-button {
        margin-bottom: 4%;
    }
    .operate-button button{
        display: flex;
        float: right;
        margin-right: 5px;
    }
    .form-error {
        color: darkred;
        font-size: smaller;
    }
</style>
{% endblock %}

{% block content_head %} 导入模型 {% endblock %}
{% block content_inner %}
<form style="width: 60%">
    <div class="form-group">
        <label class="required" for="model-name">名称</label>
        <input type="text" class="form-control" id="model-name" placeholder="必填：模型名称" required>
    </div>
    <div class="form-group">
        <label class="required" for="model-type">类型</label>
        <select class="form-control selectpicker" data-live-search="true" id="model-type" title="选择：模型类型">
            <option>深度学习模型1</option>
            <option>深度学习模型2</option>
            <option>深度学习模型3</option>
        </select>
    </div>
    <div class="form-group">
        <label class="required" for="model-version">版本</label>
        <input type="text" class="form-control" id="model-version" placeholder="必填：模型版本" required>
    </div>
    <div class="form-group">
        <label class="required" for="model-file">文件</label>
        <input type="file" class="form-control" id="model-file" required>
    </div>
    <div class="form-group">
        <label for="model-description">描述</label>
        <textarea class="form-control" rows="5" id="model-description" placeholder="模型描述"></textarea>
    </div>

    <div class="operate-button">
        <button type="button" class="btn btn-primary create" disabled="disabled">导入</button>
        <button type="button" class="btn btn-default cancel">取消</button>
    </div>
</form>
<!-- 转圈动画 -->
<div id="loading" class="submit_loading" style="display:none">
    <div class="loading_show">
        <img src="/static/image/loading.gif">
        <p class="loading_context">正在导入模型，请稍候。。。</p>
    </div>
</div>
<script>
    let nav_list = ['首页', '项目', '查看项目', '导入模型'];
    let error_msg = '';
    $(function () {
        load_nav(nav_list);
        $("#model-file").fileinput({
            language:'zh',
            showPreview: false,
            showUpload: false
        });
    });
    $("#model-name, #model-version").blur(function(){
        // 先清空所有的span元素
        clear_error_feedback(this);
        // 校验
        let value = $(this).val().trim();
        if(value == ""){
            error_msg = "不可为空";
            set_error_feedback(this, error_msg);
        }
    });
    $("#model-name, #model-version").on('change', function () {
        if ($('#model-name').val().trim() == '' || $('#model-version').val().trim() == '' || $('#model-type').val().trim() == '')
            $('.create').attr('disabled', true);
        else
            $('.create').attr('disabled', false);
    });
    $('#model-type, #model-file').on('change',function(){
        clear_error_feedback(this);
    });
    $('.cancel').click(function () {
        window.history.back(-1);
    });
    $('.create').click(function () {
        // 检查 模型类型
        let type = document.getElementById('model-type');
        if(type.value == ''){
            clear_error_feedback(type);
            error_msg = '请选择模型类型';
            set_error_feedback(type, error_msg);
            return ;
        }
        // 检查 模型文件
        let file = document.getElementById('model-file');
        if(file.files.length == 0){
            clear_error_feedback(file);
            error_msg = '请上传模型文件';
            set_error_feedback(file, error_msg);
            return ;
        }
        // 开始传递表单内容
        let name = document.getElementById('model-name');
        let version = document.getElementById('model-version');
        let description = document.getElementById('model-description');
        let upload_data = new FormData();
        upload_data.append('name', name.value);
        upload_data.append('type', type.value);
        upload_data.append('version', version.value);
        upload_data.append('description', description.value);
        upload_data.append('file', file.files[0]);
        //var request = new XMLHttpRequest();
        //request.open("POST", "");
        //request.send(upload_data);
        $.ajax({
            type: "POST",
            data: upload_data,
            dataType: 'json',
            processData:false,  //tell jQuery not to process the data
            contentType: false,  //tell jQuery not to set contentType
            beforeSend:function () {
                $('#loading').show();
            },
            success:function(data){
                $('#loading').hide();
                if(data['code'] == 1000) {
                    //window.location = '/model/view/'+data['msg'];
                    alert('导入成功');
                }
                else {
                    alert('导入失败');
                }
            }
        });
    });
</script>
{% endblock %}